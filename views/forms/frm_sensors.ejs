<div id="frm_sensor">
    <div class="panel panel-default" id="sensor-widget">
        <div class="panel-heading clearfix">
            <h4 class="panel-title pull-left" style="padding-top: 7.5px;">Sensors</h4>
            <button class="btn btn-success btn-xs pull-right" id="add-sensor-btn">
                <i class="fa fa-plus"></i> Add New Sensor
            </button>
        </div>
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover" id="sensor-table">
                    <thead>
                    <tr>
                        <th>Room</th>
                        <th>Sensor Name</th>
                        <th>Sensor Type</th>
                        <th>Sensor Id</th>
                        <th class="text-right">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="sensor-table-body">
                    <% sensors.forEach(function(sensor){ %>
                    <tr data-sensor="<%= sensor.sensorID %>">
                        <td><%= sensor.room %></td>
                        <td><%= sensor.sensor_name %></td>
                        <td><%= sensor.sensor_type %></td>
                        <td><%= sensor.sensorID %></td>
                        <td class="text-right">
                            <button class="btn btn-danger btn-xs delete-sensor-btn">
                                <i class="fa fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Handle "Add New Sensor"
    document.getElementById('add-sensor-btn').addEventListener('click', function() {
        var tbody = document.getElementById('sensor-table-body');

        // Create editable row
        var tr = document.createElement('tr');
        tr.innerHTML = `
        <td>
            <select class="form-control input-sm" id="new-sensor-room">
            <option value="">Select room...</option>
            <% rooms.forEach(function(room){ %>
            <option value="<%= room.room_name %>"><%= room.room_name %></option>
            <% }) %>
            </select>
        </td>
        <td>
            <input type="text" class="form-control" id="new-sensor-name" placeholder="Enter a sensor name">
        </td>
        <td>
            <select class="form-control input-sm" id="new-sensor-type">
            <option value="">Select sensor type...</option>
            <% sensorTypes.forEach(function(type){ %>
            <option value="<%= type.sensor_type %>"><%= type.sensor_type %></option>
            <% }) %>
            </select>
        </td>
        <td class="empty-id">
        </td>
        <td class="text-right">
        <button class="btn btn-primary btn-xs" id="save-sensor-btn" disabled>Save</button>
        <button class="btn btn-default btn-xs" id="cancel-sensor-btn">Cancel</button>
        </td>
        `;

        tbody.appendChild(tr);
        document.getElementById('add-sensor-btn').disabled = true;

        const roomSelect = document.getElementById('new-sensor-room');
        const nameInputed = document.getElementById('new-sensor-name');
        const typeSelect = document.getElementById('new-sensor-type');
        const saveBtn = document.getElementById('save-sensor-btn');

        // Enable Save only when both selected
        function updateSaveState() {
            saveBtn.disabled = !(roomSelect.value && typeSelect.value && nameInputed.value);
        }
        roomSelect.addEventListener('change', updateSaveState);
        typeSelect.addEventListener('change', updateSaveState);

        // Save new sensor
        saveBtn.addEventListener('click', function() {
            const selectedRoom = roomSelect.value;
            const selectedType = typeSelect.value;
            const inputedName = nameInputed.value;

            if (!selectedRoom || !selectedType || !inputedName) return;

            $.post("http://localhost:3000/api/addSensor", { room: selectedRoom, sensor_name: inputedName, sensor_type: selectedType })
                    .done(function() {
                        addSensor(); // refresh
                    })
                    .fail(function(xhr) {
                        if (xhr.status === 409) {
                            alert("Sensor already exists for this room!");
                        } else {
                            alert("Error saving sensor: " + xhr.statusText);
                        }
                    });
        });

        // Cancel
        document.getElementById('cancel-sensor-btn').addEventListener('click', function() {
            tr.remove();
            document.getElementById('add-sensor-btn').disabled = false;
        });
    });

    // Handle "Delete" button
    document.getElementById('sensor-table-body').addEventListener('click', function(e) {
        if (e.target.closest('.delete-sensor-btn')) {
            const tr = e.target.closest('tr');
            const sensorId = tr.getAttribute('data-sensor');

            if (confirm('Are you sure you want to delete this sensor?')) {
                $.post("http://localhost:3000/api/deleteSensor", { id: sensorId })
                        .done(function() {
                            addSensor(); // refresh table
                        })
                        .fail(function(xhr) {
                            alert("Error deleting sensor: " + xhr.statusText);
                        });
            }
        }
    });

    // Initialize (loads sensor table)
    renderSensors();
</script>

<!-- Dependencies -->
<!--<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">-->
<!--<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">-->
<!--<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>-->
<!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/1.0.8/js/sb-admin-2.min.js"></script>-->

<script src="../Layout/js/scripts.js"></script>
