<style>
/* Modern Temperature Widget Styles */
:root {
  --widget-primary: #2980b9;
  --widget-primary-dark: #1a5276;
  --widget-primary-light: #3498db;
  --widget-accent: #5dade2;
  --widget-bg: #f8fafc;
  --widget-card-bg: #ffffff;
  --widget-text: #2c3e50;
  --widget-text-muted: #7f8c8d;
  --widget-online: #27ae60;
  --widget-offline: #e74c3c;
  --widget-border: #e1e8ed;
}

.widget-card {
  background: var(--widget-card-bg);
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  margin-bottom: 24px;
  border: none;
}

.widget-header {
  background: linear-gradient(135deg, var(--widget-primary) 0%, var(--widget-primary-light) 100%);
  color: #ffffff;
  padding: 20px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.widget-header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.widget-icon {
  width: 56px;
  height: 56px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
}

.widget-title {
  margin: 0;
  font-size: 22px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.widget-subtitle {
  margin: 4px 0 0 0;
  font-size: 13px;
  opacity: 0.85;
}

/* Status Badge */
.status-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  text-transform: capitalize;
}

.status-badge.online {
  background: rgba(39, 174, 96, 0.2);
  color: #ffffff;
}

.status-badge.offline {
  background: rgba(231, 76, 60, 0.25);
  color: #ffffff;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.status-badge.online .status-dot {
  background: var(--widget-online);
  box-shadow: 0 0 8px var(--widget-online);
  animation: pulse-online 2s infinite;
}

.status-badge.offline .status-dot {
  background: var(--widget-offline);
}

@keyframes pulse-online {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}

/* Widget Body */
.widget-body {
  padding: 24px;
}

.readings-grid {
  display: flex;
  gap: 24px;
  margin-bottom: 24px;
}

.reading-card {
  flex: 1;
  background: var(--widget-bg);
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  border: 1px solid var(--widget-border);
  transition: all 0.2s ease;
}

.reading-card:hover {
  border-color: var(--widget-accent);
  box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
}

.reading-icon {
  font-size: 24px;
  color: var(--widget-primary);
  margin-bottom: 8px;
}

.reading-label {
  font-size: 13px;
  color: var(--widget-text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.reading-value {
  font-size: 36px;
  font-weight: 700;
  color: var(--widget-text);
  line-height: 1;
}

.reading-unit {
  font-size: 18px;
  font-weight: 400;
  color: var(--widget-text-muted);
  margin-left: 2px;
}

/* Setpoint Control */
.setpoint-control {
  background: var(--widget-bg);
  border-radius: 10px;
  padding: 20px;
  border: 1px solid var(--widget-border);
}

.setpoint-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.setpoint-header i {
  color: var(--widget-primary);
  font-size: 18px;
}

.setpoint-header span {
  font-size: 14px;
  color: var(--widget-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 500;
}

.setpoint-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

.setpoint-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid var(--widget-accent);
  background: transparent;
  color: var(--widget-accent);
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.setpoint-btn:hover {
  background: var(--widget-accent);
  color: #ffffff;
  transform: scale(1.05);
}

.setpoint-btn:active {
  transform: scale(0.95);
}

.setpoint-value {
  font-size: 48px;
  font-weight: 700;
  color: var(--widget-text);
  min-width: 100px;
  text-align: center;
}

/* Widget Footer */
.widget-footer {
  border-top: 1px solid var(--widget-border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: background 0.2s ease;
}

.widget-footer:hover {
  background: var(--widget-bg);
}

.widget-footer a {
  color: var(--widget-primary);
  text-decoration: none;
  font-weight: 500;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.widget-footer a:hover {
  color: var(--widget-primary-dark);
  text-decoration: none;
}

.widget-footer i {
  font-size: 18px;
  transition: transform 0.2s ease;
}

.widget-footer:hover i {
  transform: translateX(4px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .widget-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
  
  .readings-grid {
    flex-direction: column;
  }
  
  .setpoint-value {
    font-size: 40px;
  }
}
</style>

<% Object.keys(roomCache).forEach(function(roomName) { 
    const room = roomCache[roomName]; 
    const isOnline = room.sensor_status === 'online';
%>

<div class="row">
  <div class="col-lg-6 col-md-8 col-sm-12">
    
    <div class="widget-card">
      <!-- Header -->
      <div class="widget-header">
        <div class="widget-header-left">
          <div class="widget-icon">
            <i class="fa fa-cloud"></i>
          </div>
          <div>
            <h2 class="widget-title"><%= room.sensor_name %></h2>
            <p class="widget-subtitle">Temperature & Humidity Monitor</p>
          </div>
        </div>
        <div class="status-badge <%= isOnline ? 'online' : 'offline' %>">
          <span class="status-dot"></span>
          <!--<span><%= room.sensor_status %></span>-->
          <span>Offline</span>
        </div>
      </div>
      
      <!-- Body -->
      <div class="widget-body">
        <!-- Temperature & Humidity Readings -->
        <div class="readings-grid">
          <div class="reading-card">
            <div class="reading-icon">
              <i class="fa fa-thermometer-half"></i>
            </div>
            <div class="reading-label">Room Temperature</div>
            <div class="reading-value">
              <%= room.last_temperature !== null && room.last_temperature !== undefined ? room.last_temperature : '--' %><span class="reading-unit">째C</span>
            </div>
          </div>
          
          <div class="reading-card">
            <div class="reading-icon">
              <i class="fa fa-tint"></i>
            </div>
            <div class="reading-label">Room Humidity</div>
            <div class="reading-value">
              <%= room.last_humidity !== null && room.last_humidity !== undefined ? room.last_humidity : '--' %><span class="reading-unit">%</span>
            </div>
          </div>
        </div>
        
        <!-- Setpoint Control -->
        <div class="setpoint-control">
          <div class="setpoint-header">
            <i class="fa fa-sliders"></i>
            <span>Temperature Setpoint</span>
          </div>
          <div class="setpoint-row">
            <button type="button" class="setpoint-btn" onclick="scadTemp('<%= roomName %>');">
              <i class="fa fa-minus"></i>
            </button>
            <div class="setpoint-value setpoint-<%= roomName %>">
              <%= room.temp_setpoint %><span class="reading-unit">째C</span>
            </div>
            <button type="button" class="setpoint-btn" onclick="crescTemp('<%= roomName %>');">
              <i class="fa fa-plus"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="widget-footer">
        <a href="javascript:;" onclick="getAChart();">
          <span>View Details</span>
          <i class="fa fa-arrow-circle-right"></i>
        </a>
      </div>
    </div>
    
  </div>
</div>

<% }); %>

<script>
function crescTemp(roomName) {
  console.log('Increasing temperature setpoint for room:', roomName);
  
  var setpointEl = document.querySelector('.setpoint-' + roomName);
  var currentText = setpointEl.textContent || setpointEl.innerText;
  var currentSetpoint = parseInt(currentText);
  var newSetpoint = currentSetpoint + 1;
  
  $.ajax({
    type: 'POST',
    url: 'http://localhost:3000/api/crescTemp',
    contentType: 'application/json',
    data: JSON.stringify({
      room: roomName,
      newSetpoint: newSetpoint
    }),
    success: function(data) {
      console.log('Temperature setpoint increased successfully:', data);
      setpointEl.innerHTML = newSetpoint + '<span class="reading-unit">째C</span>';
    },
    error: function(err) {
      console.error('Error increasing temperature setpoint:', err);
      alert('Error updating temperature setpoint');
    }
  });
}

function scadTemp(roomName) {
  console.log('Decreasing temperature setpoint for room:', roomName);
  
  var setpointEl = document.querySelector('.setpoint-' + roomName);
  var currentText = setpointEl.textContent || setpointEl.innerText;
  var currentSetpoint = parseInt(currentText);
  var newSetpoint = currentSetpoint - 1;
  
  $.ajax({
    type: 'POST',
    url: 'http://localhost:3000/api/scadTemp',
    contentType: 'application/json',
    data: JSON.stringify({
      room: roomName,
      newSetpoint: newSetpoint
    }),
    success: function(data) {
      console.log('Temperature setpoint decreased successfully:', data);
      setpointEl.innerHTML = newSetpoint + '<span class="reading-unit">째C</span>';
    },
    error: function(err) {
      console.error('Error decreasing temperature setpoint:', err);
      alert('Error updating temperature setpoint');
    }
  });
}
</script>
